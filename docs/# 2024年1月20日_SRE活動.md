# 2024年1月20日_SRE活動

## 時間

1/20 18:00-19:00(1 hour)

## やること

- 負荷試験するとしたら、どんなところに着目して、どのような進め方・目標で実施する

## 備忘録

- 負荷試験するとしたら、どんなところに着目して、どのような進め方・目標で実施する

   - 試験実施のポイントを考える
        - 想定ユースケースにおけるシステムの応答性能を推測する
            - サービス利用開始直後にユーザが大量に登録する
              - ユーザーの登録シナリオもテストに含める
            - 順調にサービスが稼働した後データが大量に溜まった
              - データの量が増えた状態でのシナリオもテストに含める
            - キャンペーン告知などで急激なユーザアクセスが見込まれる
              - スパイクが見込まれる状態でのシナリオもテストに含める
            - 再起動後などでキャッシュが揮発した状態
              - キャッシュ利用時はキャッシュが揮発した状態と揮発していない状態の両方をテストに含める
            - システムが異常系の応答を返す状態で利用された場合
              - システム上の特定の要素が異常応答を返す状態になった場合（例：データベースがダウンした場合）のシナリオもテストに含める
            - バッチなどとバッティングした場合

        - ピーク時における単位時間当たりの利用ユーザ数を推測する
            - 複数スレッドでの実行・複数回のシナリオ実行を行う
            - 利用ユーザ数を増やしていく
            - 同時利用可能者数の上限を考察する
            - １秒間に受付可能なリクエスト数を考察する
            - １日に受付可能なリクエスト数を考察する
            - メルマガやPush通知であれば 配信数 x 反応期待値 でスパイクによって増えるアクセス数の概算が算出できます。
            - テレビであれば「放映対象世帯数 x 視聴率 x 反応期待値」
            - ELBの暖機運転
            - オートスケール設定は数分でWebサーバの台数増減が機能する仕組み。スパイク時はあまり効果がない。
        - 試験を複数回行う
          - 試験結果のばらつきを確認する
        - 試験対象システムに負荷が集中している状態を作る
          - ボトルネック部分を特定できている状態を目指すべく、負荷試験実施中は、実際の負荷試験対象部分に負荷がかかっている状態を意図的に作る必要がある
        - 負荷試験シナリオに含まれているべきページ・リクエスト
          - アクセス頻度が高いもの
          - サーバリソース消費量が高いことが想定されるもの
            - CPU
              - ファイル圧縮・展開操作
              - パスワード暗号化・認証
              - 画像・動画コンバート
            - ネットワーク
              - 
            - ディスク
          - DB参照するもの
          - DB更新するもの
          - 外部システムと通信するもの
   - 試験準備・試験計画から考える
        - 負荷試験の目的
         - システムがスケール性を持つことを確認する
            - スケール特性（どこを増強すれば性能が向上するか）を把握する
                - スループットレベル（１００RPS、５００RPS）を処理する
   
        - 前提条件・制約事項の整理
            - 開発チームは負荷試験に参加できない
            - ユーザの利用動線に関するシナリオは示されていない
            - 外部結合先のシステムなど、本番稼働中インフラと共有部分がある

        - 目標値

        - 利用する負荷試験ツール（攻撃ツール）
            - Webアプリケーションに対してHTTP(S)リクエストを発生させる
                - リクエストを正しくシミュレーションする
                - 攻撃の強さ（同時起動数、リクエスト間隔、最大スループットなど）を制御可能
                - 対象システムに対して十分な負荷を発生させる
                    - 以下のケースは、対象システムに対し十分な負荷を発生させる妨げになることがある（攻撃ツール・攻撃サーバの選定や設定の問題によって、負荷試験にならないケース）
                    - TLS/SSL接続の確率および計算処理のためのコストが攻撃サーバに集中すると
                    - HTTPリクエストのたびに通信を遮断・再接続してしまうと、攻撃サーバにとっての過剰な負荷になる
                - 攻撃ツールの設置場所、起動場所を選択可能

        - 試験実施環境
          - 攻撃サーバ（負荷試験のリクエスト元になるサーバ。個人PCの場合も。） 
            - できるだけ試験対象システムに近い場所から攻撃する
          - 試験対象システム
            - 負荷試験のリクエスト先になるサーバ。本番環境になる場合もあれば、負荷試験専用の環境を用意したり、開発環境を併用する場合も
                - 外部結合先のシステムなど、本番稼働中インフラと共有部分がある場合特に注意が必要
                - 負荷試験用環境を手配する場合、試験準備期間に構築の作業を見込んでおく
            - 商用環境と異なる環境での負荷試験
                - 構成が大きく異なる場合、結論から言うと無意味となることが多い
                - 負荷試験環境の構成は必ず商用環境の構成に寄せる
            - 外部システム結合がある場合の環境構築
                - 該当の外部システムのダミー応答をするスタブサーバを構築する（推奨: 高負荷時はTCP/IP通信コストも無視できないので、通信のシミュレーションも含めた試験を行う）
                - プログラム内で外部システム連携部分のスタブを準備する
        - スケジュール
            - 試験準備　1週間
                - 担当者決め
                - テストシナリオ作成
                - 試験実施環境の構築
                  - 攻撃サーバの準備
                  - 試験対象システムの環境作成
                    - 試験用アプリケーション修正・スタブ準備
                - 利用する負荷試験ツール（攻撃ツール）の選定
          - 試験実施
            - 準備ができて結果が出始めるまでが大体１−2週間
            - あとはテスト内容次第
          - 試験結果報告
          - 分析・改修
            - 内容次第。１個あたり２ー３営業日。
            - 問題点ー＞改修ポイント→修正・デプロイ→リリース
        - 負荷試験シナリオ
            - ユーザーの登録シナリオ
            - データの量が増えた状態でのシナリオもテスト
            - スパイクが見込まれる状態でのシナリオもテスト
            - キャッシュ利用時はキャッシュが揮発した状態と揮発していない状態の両方をテスト
            - システム上の特定の要素が異常応答を返す状態になった場合（例：データベースがダウンした場合）のシナリオもテスト


   - 試験レポートから考える
        - 結論
        - 前提条件
        - 試験目的
            - システムがスケール性を持つことを確認する
            - スケール特性（どこを増強すれば性能が向上するか）を把握する
                - スループットレベル（１００RPS、５００RPS）を処理する
        - 試験内容
        - 試験結果
            - 同時利用可能者数X人
            - 同時受付可能応募数（秒間）
            - 平均レスポンスタイム
            - スループット（単位時間あたりの処理量）
            - リソース使用状況
        - システム改善提案
            - 冗長度を上げることによる可用性向上
            - XXを増強すれば性能が向上する

   - システム構成・アプリケーション構成から考える(TBD)
        - クラウドサービスを利用したシステム構成
            - サーバレスアーキテクチャを利用したWebアプリケーション
              - DNSサービス、Applicationゲートウェイサービス、コンピューティングサービス、データベースサービス
   
# 2023年1月15日_SRE活動

## 時間

- 1/15 12:00-15:52(3h52m)

## やること

- サイトリライアビリティワークブック 2. SLOの実装 を読んで学ぶ
- サイトリライアビリティワークブック 9. インシデント対応 を読んで学ぶ
## 備忘録

- SLIの仕様と実装
  - 仕様: 100ms未満でロードされたホームページリクエストの比率
    - 計測と評価の独立が前提
  - 実装
    - サーバログのレイテンシー列で計測されたもの
    - 仮想マシンで動作するブラウザから計測して報告される（ネットワーク未達の問題はこの方法でも捕捉されるが、仮想マシンとブラウザを用いた計測手段＝実ユーザの操作を計測しているわjではないため、一部のユーザにしか影響のない問題は見落とすかもしれない）
    - 実際のサイトからJavascriptで計測し、専用のテレメトリ計測サービス経由で報告する
  - 最初のSLIは、エンジニアリングの作業が最も少なくて済むもの
    - 最初のSLIではなく改善を加えていく場合（セットアップしたフィードバックループがうまく回ってる場合）、その限りではない
      - SLOターゲットの継続的改善
        - SLOターゲットの継続的改善

- SLIとして機能する数値を定義する際の推奨
  - 良いイベントの数をイベントの総数で割る（全体（総数）に対する成功した数の割合＝構成比率）を指標とすること
    - 成功したHTTPリクエスト数 ／ HTTPリクエストの総数
    - 100ms以内で正常終了したgRPCリクエスト数 ／ gRPCリクエストの総数
    - 何かの条件リストに基づく「正常終了ユーザ・  分」の長さ ／ 「すべてのユーザ・  分」の総数
    - 10分以内の新鮮な株式データを使ったプロダクト検索の「製品在庫チェックカウント」リクエスト数 ／ 製品在庫チェックリクエストの総数
      - 特定の機能や時間範囲など任意の条件に該当するユーザ・リクエストの比率
          - いや、多分、最新のデータが活用されて、製品在庫チェックがされていることがサービスの質を語る上で重要だということ
            - 10分以内の新鮮な株式データ（時間閾値条件付き）プロダクト検索（特定機能）

- 最初のSLIと継続的改善 
  - SLO を使用したサービスの健全性の評価は、主要なパフォーマンス指標であるサービス レベル インジケーター (SLI)に基づいて、明確で測定可能な目標を設定すること
    - 主要なパフォーマンス指標であるサービス レベル インジケーター (SLI)を特定する
    - 測定可能な目標を設定する
    - SLO を使用したサービスの健全性の評価
    - 何もしないのにいるというのは基本的にダメだということ（何かするか、もしくは去るか）
    - 何もやってないと後から不満を爆発させる人が多いとも言える
    - 離脱直前にタスクを振るのは基本的にX
    - 引き継ぎについてはやることがないのと、何をしたら良いか曖昧なことの２つを区別する
  - 最初のSLI実装は、エンジニアリングの作業が最も少なくて済む方法を選ぶと良い
    - 改善を加えていく場合（セットアップしたフィードバックループがうまく回ってる場合）、その限りではない
      - 実装方法は、コスパの良い、運用のしやすい、高精度な？運用
  - SLOターゲットの継続的改善
    - SLOのカバレッジ?
        - カバレッジ不足への対応策（対応措置）
        - SLOの変更
            - SLIが問題を示してる（アラートが出てる）が、SLOは誰にも通知や反応を促したりしてない場合
            - SLOを厳しくする
            - 偽陽性だった日
            - 緩和する
        - SLIの実装変更
        - 野心的なSLOの制定
        - イテレーション

- コンポーネント（アーキテクチャ）とSLIの種類
  - リクエスト駆動
    - 可用性
      - レスポンスに成功したリクエストの比率
    - レイテンシ
      - 閾値よりも高速に処理されたリクエストの比率
        - レイテンシの平均値を目標値とするのはやめましょう。望みどおりの結果はほぼ出ない https://cloud.google.com/blog/ja/products/gcp/building-good-slos-cre-life-lessons
          - 平均値は異常値を隠してしまうことがありますし、かなり小さい数値はゼロと見分けがつきません
        - その代わりに、レイテンシが L 秒未満のリクエストの割合の目標値を P %など、処理されたリクエスト全体の割合と目標処理時間でSLIを定義する
          - 99thパーセンタイル 3000ミリ秒
        - 今後のためにも、論理的根拠を基に目標値を設定
    - 品質
      - サービスがグレースフルデグラレーションするのであれば、グレードが低下していない状態で返されたレスポンスの比率を計測する必要がある
        - レジリエンス（回復力）と グレースフル・デグラデーション 4つの既成のプラクティス https://newrelic.com/jp/blog/best-practices/design-software-for-graceful-degradation
            - ワークロードを削除する
              - ロードシェディング
                - どのリクエストを削除するかを決定することが設計上重要
                - シンプルなアプローチは、しきい値を超えたときにすべてのリクエストを削除する方式
                  - 簡単ですが、サービスレベルの違いや特定のリクエストを優先させることはできません
                  - 例えば、ヘルスチェックは他のリクエストよりも優先されるべきですが、このアプローチでは優先されません
            - ワークロードを遅延させる
                - 過剰な作業負荷の処理を遅延処理させること
                - メッセージキューは、この種の非同期処理のためにデータをバッファリングするために広く使われています。
                  - 使用する際には、トランザクションの範囲に注意が必要
                    - 一連のサービス呼び出し全体を成功または失敗にしなければならないときに、トランザクションが正しくロールバックされるようにするには、追加のロジックが必要になるかもしれません
            - サービス品質を低下させる
                - ワークロードがあふれているが、削除したり遅延させたりしたくない場合には、サービスの品質を下げる
                  - システムにストレスが掛かった場合
                    - 利用可能な機能を一時的に減らす
                      - リクエストを処理するためのデータベースクエリを、決定論的なクエリのかわりに近似的な値を出すクエリに切り替えたりする
            - キャパシティを追加する
                - ワークロードのスパイク対応として、キャパシティを追加することのがほとんどの場合で最善な選択肢
                  - パブリッククラウドでは、VM等多くのインフラストラクチャ資源がオートスケールに対応
                - 理想的には、顧客体験の観点からは、ワークロードを削除したり遅延させたり、サービス品質を低下させたりしないのがベスト
        - 高度なキャパシティ・プランニングとプロアクティブなモニタリングによって、チームはより回復力のあるサービスを構築することができるようになる
          - プロアクティブなモニタリング? https://docs.newrelic.com/jp/docs/alerts-applied-intelligence/applied-intelligence/anomaly-detection/anomaly-detection-applied-intelligence/
            - newrelicではプロアクティブなモニタリングというワードに関連づけて、「応用インテリジェンスによる異常検出」の名目で整理された記事を紹介してきた
                - スループット、エラー率、レイテンシの 3 つの主要なゴールデン シグナルを監視
                    - システムのパフォーマンスに異常値がある場合はチームに警告する
                        - 異常ダッシュボードを使用して、何がいつ変更されたかを確認
                        - 自動異常は、チームが APM で監視されているアプリケーションの異常な動作について学習するための最も効率的な方法
                          - これらの指標のベースライン パフォーマンス
          - キャパシティプランニング ベストプラクティス https://newrelic.com/blog/best-practices/capacity-planning
            - キャパシティプランニングのプロセス 4つの質問
                - 現在、各サービスにどれくらいの空き容量が存在しますか?
                - 各サービスにはどのくらいの容量バッファが必要ですか?
                - 顧客主導の自然な成長と新しい製品機能の両方を考慮した場合、現在から次の容量計画反復までの間に、ワークロードはどの程度増加すると予想されますか?
                - 予想されるワークロードの増加後も目標の空き容量バッファーを確保するには、各サービスにどのくらいの容量を追加する必要があるでしょうか?
            - キャパシティ プランニングの効果
                - リソースの効率的な利用、コスト削減、システムパフォーマンスの強化、拡張性、情報に基づいた意思決定、リスク軽減、ダウンタイムの削減などを実現
            - キャパシティ プランニングの期間目標
                - 短期的なキャパシティプランニング
                - 当面のリソースのニーズに焦点
                    - 通常は数週間から数か月にわたる期間
                - 長期的なキャパシティプランニング
                - 数か月、場合によっては数年先までを見据えた、より広い視野が必要
  - パイプラインアーキテクチャ
    - 正確性
    - カバレッジ
  - ストレージ
    - 耐久性
      - 書き込まれたレコードのうち、正しく読み出せるものの比率


      
- Amazon CloudWatch Application Signals (プレビュー版) 
  - Application Signals を使用すると、サービスレベル目標 (SLO) を作成して、ビジネスへの影響が大きいメトリクスに重点的に取り組むことができる
    - https://aws.amazon.com/jp/about-aws/whats-new/2023/11/amazon-cloudwatch-applications-signals-observe-preview/
      - 米国東部 (バージニア北部)、米国東部 (オハイオ)、欧州 (アイルランド)、アジアパシフィック (シドニー)、アジアパシフィック (東京) の各リージョンで利用可
      - Nov 30, 2023時点でプレビュー版

- 9. インシデント対応
  - インシデント対応と問題解決を同時並行で管理するとは?
    - インシデントを解決する(対応+問題解決?)
      - インパクトを緩和
      - サービスを以前の状態に戻す
    - インシデントの管理(対応と問題解決を同時並行で行うこと?)
      - 対応チーム
      - 効率的なやり方
      - 調整
      - コミュニケーションの流れを確保
    - 構造化された方法でインシデント対応する（大前提）
      - 災害が起こる前にコミュニケーション・作業調整

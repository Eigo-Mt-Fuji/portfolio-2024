# 2024年1月4日　SRE活動

## 時間

1/4 19:10-21:39(2.49h)

## やること

- 現実世界における類例を、面談の情報をもとに掘り下げていく

  - Datadogでのモニタリング実践

  - Docker on EC2
    - 構成の特徴・よくある課題の確認

      - アーキテクチャ目線での特徴を整理する
        - 最新のOS（EC2）で構成する場合のサーバ内アーキテクチャ
          - インスタンス
            - AMI(OS)
            - インスタンスタイプ(スペック, CPU、メモリ、ストレージ、など)
            - VPC・サブネット(ネットワーク)
            - ルーティング(ネットワーク)
            - セキュリティグループ(セキュリティ)
            - キーペア(セキュリティ)
            - インスタンスプロファイル・IAMロール(セキュリティ)
            - ミドルウェア
              - Docker amazon-linux-extras install docker
                - Dockerfile
                    - Webサーバーの場合
                        - ベースイメージ(OS)
                        - Nginx
        - 負荷分散
          - AutoScaling?

        - メンテナンス
          - Systems Manager
          - Terraform / Management Console?

        - オーケストレーション
            - Step Functions (ワークフロー)
            - Event Bridge ( スケジュール実行 )
            - Application Load Balancer (Webアプリケーション)

      - このような構成の状況で次に目指すべき目標
        - アプリケーションをコンテナ化するべきか
          - コンテナを検討するべきタイミング
            - サービスの機能やユーザーの利用者数に合わせて
            - システムの仕様やインフラ・ミドルウェアが大きく変わる可能性がある
            - 老朽化したシステムをリニューアルしたい
            - が、当時のインフラ担当者は退職しており、そもそも誰も手を付けられない状態になっている
            - が、古い技術を今更学び直そうという人材も居ない
          - コンテナを採用する時のデメリット.
            - インフラに大幅な変更が加わることによって大きなメリットをもたらすとともに、当然として副作用は存在します
              - 既に稼働しているシステムがあり、インフラに大きな問題を抱えておらず安定した開発・運用が続いているならばコンテナ化するデメリットを考慮するべき
                - サーバー単体をフルで活用出来ている場合に比べるとコストが増える可能性がある(サーバのコストパフォーマンス)
                - 移行に際して構成環境の変化／コストの再試算／運用手順の学習／テストに工数が発生(移行コスト)
                - 要件によってはセキュリティ基準を確保することが難しい場合が存在する(非機能要件)
                - 継続的に開発を続けるシステムでない場合はコンテナ技術がかえって安定運用の妨げになる可能性(Dockerという技術自体のリスク)
          - メリット
            - 公式／非公式を問わず多数公開されているDockerイメージを用いる事により、システムの目的に対して適切な環境構築の手間を削減できる
            - 開発プロセスとして自身のPCにDockerイメージを起動できるようにすることで、開発者がより本番に近い構成でサービスを開発でき、開発環境の構築手順を削減できる
            - より本番に近い構成で自動テストを行える
              - 開発中に本番に近い構成のDockerイメージで自動テスト・ベンチマークを気軽に行えるため、準備をしておけば
            - アプリケーションのリリースもDockerイメージを前提とする場合
              - 自分でシェルスクリプトを書く必要が無くなり、ケアレスミスを防げる
                - それを支援するアプリケーションやサービスが存在するため?
                  - ほんと?
            - サーバーの増強、ミドルウェアのセキュリティアップデートをより低コストに実施できる
            - コンテナは旧来のサーバー管理手法（Chef, Ansible等）より簡単?
              - 運用コストを下げ、信頼性を確保できる
            - 沢山の物理・仮想化サーバーの煩雑な管理から開放される?
              - コンテナを一つのホストマシンに集約する
              - よりシンプルな管理手法を導入できる
        - 仮想サーバー(EC2)とコンテナ(Docker)の違い
            - AWS Fargateとは？Amazon ECSとの関係性
              - ホストマシンを意識せずにコンテナを実行できる環境
              - Amazon Elastic Container Service (ECS) と Amazon Elastic Kubernetes Service (EKS) で動作する

      - Docker on EC2のよくある問題点
        - EC2のデメリットとしてはサーバーリソースの設計が必要
        - OSの管理業務（パッチ適応など）が発生する

      - SRE業務上発生しうる問題点
       - SLO
       - 信頼性

      - 実践に必要な操作・プロセス
        - オペレーションの種類

      - IAMロール・ポリシーの最適化

      - 利用AWSサービスごとのIAMポリシー・作成済みポリシー
        - これは利用サービスを把握してないと出せない回答

      - IAMロール・ポリシーの分割単位のよくあるパターンを調べておく

  - MAU8000万の規模感で今後必要となりうるアクションをイメージしてそれに対応する準備
    - 秒間リクエスト数への変換方法（よくあるやり方）を調べてみる
    - 実際のシステム構成で、この閾値を達成するために最も関連するクォータを把握しておく

  - Terraform
    - 最新バージョン、ツール、書籍探しておくか?
  
  - Python(大多数、読み書き)

  - Go(読み書き)
    - これはプログラム書かないとダメじゃない?

- ドキュメンテーションなくても大丈夫か？という確認（成熟期マトリクスを混乱期、機能、継続的改善の３つに分けた場合、混乱期の可能性が高い）

- チームのライフサイクルを再確認し、立ち上げ・混乱・統一・機能４つのフェーズに対する自分の立ち回りをもう１段階具体的にイメージする
- 上記以外で、SREの実践本の読み直すポイントと計画を再検討する。

## まとめる

- Docker on EC2というアーキテクチャで運用している組織が抱えている課題
    - インフラ担当者は退職しており、そもそも誰も手を付けられない状態になっている
      - 古い技術を今更学び直そうという人材も居ない
    - Fargateへの移行に際して構成環境の変化／コストの再試算／運用手順の学習／テストに工数が発生することに課題感がある(移行コスト)
    - Fargateへの移行に際して要件によってセキュリティ基準を確保することが難しい状況に置かれている(非機能要件)
    - Fargateへの移行に際してサーバー単体をフルで活用出来ている場合に比べるとコストが増えるのではという課題感を感じている(サーバのコストパフォーマンス)
    - Fargateへの移行に際して継続的に開発を続けるシステムでない場合はコンテナ技術がかえって安定運用の妨げになる可能性(Faragteという技術自体のリスク)

- Docker on EC2のよくある問題点・AWS Fargateとは
    - EC2のデメリットとしてはサーバーリソースの設計が必要
    - OSの管理業務（パッチ適応など）が発生する
    - AWS Fargateとはホストマシンを意識せずにコンテナを実行できる環境
        - コンテナを採用する時のデメリット.

- Dockerコンテナを用いて構築されているシステムで本来期待できるメリット（今回の案件で期待できるかは確認してみなければわからない）
    - 公式／非公式を問わず多数公開されているDockerイメージを用いる（構成）
    - 開発中に本番に近い構成のDockerイメージの準備をしておけばより本番に近い構成で自動テストを行える（テスト）
    - サーバーの増強、ミドルウェアのセキュリティアップデートをより低コストに実施できる（メンテナンス/セキュリティパッチ適用）
    - アプリケーションのリリースもDockerイメージを前提とする場合、自分でシェルスクリプトを書く必要が無くなり、支援するアプリケーションやサービスを利用することでケアレスミスを防げる（デプロイメント）
    - 開発プロセスとして自身のPCにDockerイメージを起動できる（開発環境）
    - コンテナは旧来のサーバー管理手法（Chef, Ansible等）より運用コストを下げ、信頼性を確保できる（IaC）

- Docker on EC2というワードから予想されるアーキテクチャ上の特徴と関連するAWSサービスを具体化する
    - 最新のOS（EC2）で構成する場合のサーバ内アーキテクチャ
        - インスタンス
        - AMI(OS)
        - インスタンスタイプ(スペック, CPU、メモリ、ストレージ、など)
        - VPC・サブネット(ネットワーク)
        - ルーティング(ネットワーク)
        - セキュリティグループ(セキュリティ)
        - キーペア(セキュリティ)
        - インスタンスプロファイル・IAMロール(セキュリティ)
        - ミドルウェア
            - Docker amazon-linux-extras install docker
            - Dockerfile
                - Webサーバーの場合
                    - ベースイメージ(OS)
                    - Nginx
    - 負荷分散
        - AutoScaling?

    - メンテナンス
        - Systems Manager
        - Terraform / Management Console?

    - オーケストレーション
        - Step Functions (ワークフロー)
        - Event Bridge ( スケジュール実行 )
        - Application Load Balancer (Webアプリケーション)

- Datadogでのモニタリング実践の教材を探してみた
  - 「Datadogって何？」というDevOps中級者が、３0分で何となくわかって各サービスの違いが理解できるようになります。有料Datadogコースの前提になります！
 https://www.udemy.com/course/datadog-monitoring/
    - 他のサービスとのインテグレーション
    - Datadog ダッシュボード
    - Infrastructure ダッシュボード
    - Datadog Loggingの概念
    - Datadog イベントの概念
    - Datadog APMの概念
  - 米シリコンバレーDevOps監修！Datadog完全入門 in K8s 17800 3.5時間のオンデマンドビデオ https://www.udemy.com/course/datadog-monitoring-in-kubernetes-devops/

  - Python(大多数、読み書き)
  - Go(読み書き)
    - これはプログラム書かないとダメじゃない?
 
- MAU8000万の規模感で今後必要となりうるアクションをイメージしてそれに対応する準備
    - 秒間リクエスト数への変換方法（よくあるやり方）を調べてみる
      - 性能評価の指標を合わせる方法
        - 1万ユーザーの同時アクセス」を「秒間のリクエスト数」に落とし込む  https://ptune.jp/tech/match-performance-evaluation-indicators/
          - 秒間のリクエスト数　＝　ユーザー数　×　ページ/ユーザー　÷　想定時間(秒)　×　ピーク特性
          - ページ/ユーザーは「5」、想定時間は「5分」「1時間」「8時間」の3パターン、ピーク特性は「通常（2.5）」「高い（6）」の2パターン
          - 導入アプリ数300, 3000 10000req/sec - 100,000req/secくらい
    - 実際のシステム構成で、この閾値を達成するために最も関連するクォータを把握しておく
      - 実際のシステム構成をChatGPTに推測させてみる
        - 使われそうなAWSサービス(ChatGPT4推測)
            - Amazon S3（Simple Storage Service）: 大量のオンラインおよびオフラインのデータを安全かつ効率的に保存するために使用されます。
            - Amazon Redshift: データウェアハウスサービスであり、集められたデータの効率的な分析とレポート作成に適しています。
            - AWS Lambda: サーバーレスコンピューティングサービスで、データ処理やアプリケーションの応答などを自動化するために使用されます。
            - Amazon Pinpoint: 顧客エンゲージメントを高めるためのサービスで、ターゲットとなるセグメントに対して個別化されたプッシュ通知やメールキャンペーンを実施するのに適しています。
            - Amazon Kinesis: リアルタイムデータストリームの処理に利用され、オンラインの行動履歴やオフラインの位置情報などの大量のデータをリアルタイムで処理し、分析するのに役立ちます。
            - Amazon DynamoDB: 高速かつ柔軟なNoSQLデータベースサービスで、大量のデータを迅速に処理し、必要に応じてスケールアップするのに適しています。
            - Amazon SageMaker: 機械学習モデルを作成し、訓練し、デプロイするための完全管理型サービスで、顧客行動の予測やセグメント化に役立ちます。
        - インプット
          - 顧客のオンライン行動履歴（アプリ上の操作履歴）とオフライン行動履歴（位置情報）を統合・分析し、結び付きの強さ「ファンレベル」を判断してセグメンテーション
          - 分析後は、popinfo時から提供するアプリ施策に加え、自社アプリよりもLINEを通じたコミュニケーションが有効な顧客には、LINE公式アカウントでのプッシュ通知やOne to Oneトーク等での施策も可能になる予定
          - アプリデータの収集・分析、顧客との最適なコミュニケーションを実現。作って終わりのアプリから、コミュニケーション施策のPDCAを回していくフェーズへ。
          - 使い方のイメージとしては
            - ①オンライン/オフライン/CRMツール等のデータを取得し統合
            - ②「ファンレベル」を判断してセグメンテーション
              - ※「30日間来店なし」等、GPS/Wi-Fi/Bluetoothによる位置情報を絡めたセグメンテーションに強み
            - ③セグメントごとに効果的なチャネルを選び、One to Oneのメッセージやクーポンでアプローチ
              - ・これらの情報から想定されるアプリケーションとデータ
                -　データ: 行動履歴（アプリ上の操作履歴）, セグメント, 配信チャネル, メッセージ,顧客・顧客関係データ(カスタマー・リレーション（）,
                - アプリケーション: 行動履歴の分析, セグメンテーション（分類）, 配信チャネル管理, プッシュ通知・メッセージ配信
      - サポートページに公開されている情報を確認する
       - APIのホスティングまたは、API以外のO2Oソリューションを構成する機能に対応するシステムが構築されているはず
         - https://support.fanship.jp/hc/ja
      - アイリッジ社の事業状況
        - アプリ開発, LINEミニアプリ(スクラッチ開発, “かんたん” パッケージ), コンサルティング, FinTech, DXソリューション

- FANSHIPについてのサポートページに公開されている情報を確認する https://support.fanship.jp/hc/ja
    - API https://support.fanship.jp/hc/ja/articles/360026718253-%E5%90%84%E7%A8%AEAPI%E4%BB%95%E6%A7%98%E6%9B%B8%E4%B8%80%E8%A6%A7
      - FANSHIP InApp Message Management API - https://docs.fanship.jp/inapp-mapi/index.html?_gl=1*efmeve*_ga*MTQxNTMxNzIzMy4xNzA0MzY3MzYy*_ga_CSKGEY0E75*MTcwNDM2NzM2Mi4xLjEuMTcwNDM2NzQ2Ny4xOC4wLjA.
        - 同時アクセス数は1を上限とします
        - 短時間での大量アクセスまたは大容量データによるアクセスなど、システム負荷のかかるリクエストを避けていただくようお願いいたします
        - Linux 4.9.30; Python-requests 2.1.12) iRidge,inc
        - API
          - アプリ内メッセージ作成
          - アプリ内メッセージ（テスト）作成
          - アプリ内メッセージ一覧参照
          - アプリ内メッセージ詳細参照
          - アプリ内メッセージ有効化・無効化
      - FANSHIP Management API v3.1
        - 有償オプション
        - API
            - ログイン
            - 配信登録、フォーマット保存、フォーマット編集、テスト送信API
            - プッシュ通知ペイロード指定
            - filter による絞り込み
            - 配信一覧取得、フォーマット一覧取得 API
            - 配信情報取得、フォーマット情報取得 API
            - 配信キャンセル、フォーマット削除 API
            - 登録者情報取得 API
            - 登録者情報一覧取得 API
            - 登録者情報更新 API
            - 基本情報取得API
            - テスト端末登録・解除API
            - iOSアプリケーションの設定
            - Androidアプリケーションの設定
            - 属性情報一覧取得API
            - 属性情報登録API
            - 属性情報編集API

      - FANSHIP Management API v3.0
        - 有償オプション
        - API
            - ログイン
            - 配信登録、フォーマット保存、フォーマット編集、テスト送信API
            - 配信一覧取得、フォーマット一覧取得 API
            - 配信情報取得、フォーマット情報取得 API
            - 配信キャンセル、フォーマット削除 API
            - 登録者情報取得 API
            - 登録者情報一覧取得 API
            - 登録者情報更新 API
            - 基本情報取得API
            - テスト端末登録・解除API
            - iOSアプリケーションの設定
            - Androidアプリケーションの設定
            - 属性情報一覧取得API
            - 属性情報登録API
            - 属性情報編集API
      - FANSHIP Coupon Management API v2.0
        - API
          - クーポン新規作成
          - クーポン更新
          - クーポン詳細参照
          - クーポン削除
          - クーポン一覧参照
          - 利用可能店舗新規作成
          - 利用可能店舗更新
          - 利用可能店舗詳細参照
          - 利用可能店舗削除
          - 利用可能店舗一覧参照
          - 限定クーポン配布
          - 画像登録
      - FANSHIP Integration API v1.0
        - API
            - 会員情報アップロードAPI
            - 会員情報更新確認API
            - 購買履歴アップロードAPI
            - 購買履歴更新確認API
      - FANSHIP IDLink API v1
        - API
            - ノードの操作
              - 作成
              - IDの追加
              - 更新
              - 更新なければ作成
              - キーの再設定
              - 削除
            - リンクの操作
              - 紐付けを行う
              - 更新
              - 更新または作成
              - 削除
    - API以外の機能
        - プッシュ通知
        - 差し込み配信機能
            - 配信の48時間前までに配信登録が必要
            - 配信をキャンセルすることはできます. 配信の24時間前まではキャンセルができます。
            - 配信対象のpopinfo_idと置換する文字列を記載したCSVファイルには制限はあり, 容量は50MBまでとなっており、指定可能な置換変数は10個まで
            - 予約できる配信に制限は20件まで
            - 配信数の上限は10万件まで
        - アプリ内メッセージ
            - 全体配信・セグメント配信	配信したいユーザーを、全体か、設定したセグメントかを選択可能です。
                - 配信最大回数仕様が決められている
                - 1日の最大配信回数仕様が決められている
                - 優先度仕様が決められている
                - 起動トリガー仕様が決められている
        - App Clip
        - クーポン機能
        - アンケート画面のカスタマイズ
        - プッシュ通知API並列リクエストについて
        - イベントトラッキング機能
          - イベント名	イベント内容
          - アプリ起動	アプリを立ち上げた
          - PUSH開封	プッシュ通知をタップしてお知らせ詳細に遷移した
          - URL遷移	コンテツに設定しているURLもしくはHTML配信のリンクをタップした
          - お知らせ一覧の閲覧	一覧を表示した
          - 詳細閲覧	コンテンツを表示した
          - 初回起動	インストール後アプリを起動した
          - アプリアップデート	アプリをアップデートした
          - WiFi入圏	WiFi電波をアプリで検知した
          - iBeacon捕捉	Beacon電波をアプリで検知した
          - クーポン閲覧	クーポン詳細を閲覧した
          - クーポンもぎり	クーポンを利用した
          - クーポンお気に入り追加	お気に入り登録（☆アイコンタップ）した
          - クーポンお気に入り解除	お気に入り解除した
          - クーポン配布	限定クーポンを配布した

## 所感

`所感を整理しておく`

- MAU8000万の規模感でAPIとAPI以外の機能をみるに、同時リクエスト数は１０００ー１００,０００程度まで幅広く発生する可能性がありそう。
- 公開されてるAPI数と機能数も多い。キャッチアップにどれだけ時間がかかるかわからないが、問題に対して部分的にインプットしつつ対処していくことにはなると思う。
- アーキテクチャ変更が気軽に行える規模感ではなさそう。
- その分、SLO/SLIの導入が有効な場面はあるかもしれないし、すでに導入がされていて改善サイクルに混ざって議論することもあるかもしれない。
- 機能ごとにチャンスを作ってリプレースをかけたり改善をすることで喜ばれる場面もあるかもしれない。
- 同時リクエスト数ごとの注意点を調べておくとよいかもしれない
- アプリケーション機能分解のイメージを１段階具体化し、それぞれの機能に相当するAWSサービスを整理してから学習に取り掛かる
- 特定の技術スタックに関する無知はあらかじめ解消しておくに越したことはなさそう
- 無知じゃない場合でも、技術スタックに関する事前のインプットをやったり入れ直した状態を作ってから参画した方が良いのは間違いなさそう。
- 開始時点の機能解像度を高めておくと良いかもしれない（質疑応答を効率化しないと、乗り遅れ＝最悪すぐ首。できる限り学習コストを下げて、想定外に対処できる猶予を作っておく）

## 次のアクション

### 調査

- 同時リクエスト数ごとの注意点を調べておく -> ググって

- イシュー管理の型を調べておく
- 開始時点の機能解像度を高めておく(サポートページに公開されていた、アプリケーション機能分解のイメージを１段階具体化, 機能に相当するAWSサービスを整理) -> ChatGPTにやらせる

### 学習

- 特定の技術スタックに関する無知はあらかじめ解消しておく（DataDog -> Udemy, Python -> 本, Go -> )
  - 参画したらよくやる基本的な操作を調べておさらい
  - 基本構文のおさらい
  - 実践訓練して記憶が飛ばないようにしておく

- 相当するAWSサービス学習（学習方法の候補も上げなおす）公式サイト + Udemy?

### 訓練

- 想定される課題に対する自分なりに対応可能な案を整理して、実践訓練をやっておく
  - 作業分類を考え直しておく
    - サーバプロビジョン
    - 移行計画
    - デプロイ
    - テスト
    - システム構成図の可視化
    - SLO/SLI設定
    - ログ調査
    - デバッグ
    - 監視設定更新
  - Ansible, Terraform, AWS, Docker, Go, Python

### シミュレーション

- 参画した時点での状況によって、進め方が変化する場面が多く発生しそう。DevOps,IaC,SLOなど特に重要な観点ごとに想定されるシナリオをあげて、それぞれの初動の対処をイメージする　
